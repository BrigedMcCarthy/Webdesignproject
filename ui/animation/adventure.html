<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adventure: Fixed Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { 
            background-color: #8A8A00; /* Start in Gold Castle */
            color: #fff;
            font-family: 'Press Start 2P', cursive; 
            text-align: center;
            overflow: hidden;
            user-select: none;
            transition: background-color 0.5s ease; /* Smooth room transition */
        }

        /* CRT Scanline Overlay */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 999;
        }

        #ui-layer {
            position: relative; z-index: 2; margin-top: 40px;
            background: rgba(0,0,0,0.8); padding: 20px;
            border: 4px solid #999; display: inline-block;
            max-width: 600px;
        }

        button {
            background: #b71c1c; color: #fff; border: 4px solid #fff;
            font-family: 'Press Start 2P'; padding: 15px 20px; cursor: pointer;
            margin-top: 15px; font-size: 14px;
        }
        button:hover { background: #f05545; }

        .status-led {
            display: inline-block; width: 10px; height: 10px; 
            background: red; border-radius: 50%; margin-right: 10px;
        }
    </style>
</head>
<body>

<div class="crt-overlay"></div>

<div id="ui-layer">
    <h1 style="color:#ffeb3b; text-shadow: 4px 4px #000; margin-bottom: 10px;">ADVENTURE</h1>
    <div id="msg">SYSTEM READY</div>
    <div style="font-size: 10px; line-height: 1.8; color: #ccc; margin-top: 10px;">
        <span style="color:#ffeb3b">ARROWS</span> to Move (Speed Fixed)<br>
        <span style="color:#ffeb3b">SPACE</span> to Drop Item<br>
        Explore the screen to change "Rooms"
    </div>
    <button id="btnStart">START GAME</button>
    <button id="btnClose" style="background:#333;">RESET</button>
</div>

<script>
    /* --- AUDIO SYSTEM --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;

        if (type === 'pickup') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(600, t);
            osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'drop') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(300, t);
            osc.frequency.linearRampToValueAtTime(150, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'win') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(440, t);
            osc.frequency.linearRampToValueAtTime(880, t + 1.0);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 2.0);
            osc.start(t); osc.stop(t + 2.0);
        } else if (type === 'kill') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(10, t + 0.4);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.4);
            osc.start(t); osc.stop(t + 0.4);
        }
    }

    /* --- SPRITE DATA --- */
    const SPRITES = {
        chalice: [
            0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,
            0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,
            0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        ],
        sword: [
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,
            0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,
            0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,
            0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        ],
        dragon: [
            0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,
            0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,
            0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        ],
        dead_dragon: [
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,
            0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,
            0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        ]
    };

    /* --- GAME CONFIG --- */
    const WIN_SIZE = 60;
    const SPEED = 4; // Reduced speed for control
    const MAX_W = window.screen.width;
    const MAX_H = window.screen.height;

    let gameState = {
        running: false,
        playerWin: null,
        itemChalice: null,
        itemSword: null,
        enemyDragon: null,
        carrying: null, 
        pickupTimer: 0, 
        dragonState: 'alive',
        winFlash: false
    };

    const KEYS = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false, Space:false };

    /* --- WINDOW MANAGEMENT --- */
    
    // FIX: Completely robust window generation
    function spawn(name, x, y, sprite, color) {
        const win = window.open('', name, `width=${WIN_SIZE},height=${WIN_SIZE},left=${x},top=${y},popup=yes`);
        
        if (!win) return null;

        let content = '';
        if (sprite) {
            // 16x16 Grid
            content = `<div style="display:grid; grid-template-columns:repeat(16,1fr); width:100%; height:100%;">`;
            for(let i=0; i<256; i++) {
                // If pixel is 1, use color. If 0, use black.
                let c = sprite[i] === 1 ? color : 'black';
                content += `<div style="background:${c}; width:100%; height:100%;"></div>`;
            }
            content += `</div>`;
        } else {
            // Solid color for player
            content = `<div style="background:${color}; width:100%; height:100%;"></div>`;
        }

        // FIX: Write full HTML structure and CLOSE the document
        const fullHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${name}</title>
                <style>
                    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; }
                </style>
            </head>
            <body>
                ${content}
            </body>
            </html>
        `;

        win.document.open();
        win.document.write(fullHTML);
        win.document.close(); // This is crucial for rendering
        
        return win;
    }

    function updateWindowContent(win, sprite, color) {
        if (!win || win.closed) return;
        let content = `<div style="display:grid; grid-template-columns:repeat(16,1fr); width:100%; height:100%;">`;
        for(let i=0; i<256; i++) {
            let c = sprite[i] === 1 ? color : 'black';
            content += `<div style="background:${c}; width:100%; height:100%;"></div>`;
        }
        content += `</div>`;
        win.document.body.innerHTML = content;
    }

    function getRect(win) {
        if(!win || win.closed) return null;
        return { x: win.screenX, y: win.screenY, w: WIN_SIZE, h: WIN_SIZE };
    }

    function checkCollision(r1, r2, buffer=10) {
        if(!r1 || !r2) return false;
        return !(r2.x > r1.x + r1.w - buffer || 
                 r2.x + r2.w < r1.x + buffer || 
                 r2.y > r1.y + r1.h - buffer || 
                 r2.y + r2.h < r1.y + buffer);
    }

    /* --- ROOM LOGIC (Fog of War) --- */
    function updateRoom(pRect) {
        const cx = pRect.x + (WIN_SIZE/2);
        const cy = pRect.y + (WIN_SIZE/2);
        
        // Normalized position (0.0 to 1.0)
        const nx = cx / MAX_W;
        const ny = cy / MAX_H;

        let bgColor = "#8A8A00"; // Default Gold Castle
        let roomName = "GOLD CASTLE";

        if (ny > 0.6) {
             if (nx < 0.4) { bgColor = "#2E8B57"; roomName = "GREEN MAZE"; }
             else { bgColor = "#1a1a1a"; roomName = "BLACK CASTLE"; }
        } else if (nx > 0.6) {
             bgColor = "#4682B4"; roomName = "BLUE CATACOMBS";
        }

        document.body.style.backgroundColor = bgColor;
        // Optional: Update UI with room name if desired
    }

    /* --- MAIN LOOP --- */
    function gameLoop() {
        if (!gameState.running) return;

        if (gameState.pickupTimer > 0) gameState.pickupTimer--;

        // 1. Move Player
        let dx=0, dy=0;
        if (KEYS.ArrowUp) dy -= SPEED;
        if (KEYS.ArrowDown) dy += SPEED;
        if (KEYS.ArrowLeft) dx -= SPEED;
        if (KEYS.ArrowRight) dx += SPEED;
        
        if ((dx||dy) && gameState.playerWin) {
            gameState.playerWin.moveBy(dx, dy);
        }

        const pRect = getRect(gameState.playerWin);
        if (!pRect) return;

        // 2. Update Room Background
        updateRoom(pRect);

        // 3. Drop Logic
        if (KEYS.Space && gameState.carrying && gameState.pickupTimer === 0) {
            gameState.carrying = null;
            gameState.pickupTimer = 60; 
            playSfx('drop');
            document.getElementById('msg').innerText = "DROPPED ITEM";
        }

        // 4. Collisions
        const chaliceRect = getRect(gameState.itemChalice);
        const swordRect = getRect(gameState.itemSword);
        const dragonRect = getRect(gameState.enemyDragon);

        // Pickup
        if (!gameState.carrying && gameState.pickupTimer === 0) {
            if (checkCollision(pRect, chaliceRect)) {
                gameState.carrying = 'chalice';
                playSfx('pickup');
                document.getElementById('msg').innerText = "GOT CHALICE";
            } else if (checkCollision(pRect, swordRect)) {
                gameState.carrying = 'sword';
                playSfx('pickup');
                document.getElementById('msg').innerText = "GOT SWORD";
            }
        }

        // Carrying (Magnet)
        if (gameState.carrying === 'chalice' && gameState.itemChalice) {
            gameState.itemChalice.moveTo(pRect.x + 20, pRect.y + 20);
        } else if (gameState.carrying === 'sword' && gameState.itemSword) {
            gameState.itemSword.moveTo(pRect.x + 20, pRect.y + 20);
        }

        // Dragon
        if (dragonRect && gameState.dragonState === 'alive') {
            const dist = Math.hypot(pRect.x - dragonRect.x, pRect.y - dragonRect.y);
            if (dist < 600) { 
                // Chase
                const mx = (pRect.x - dragonRect.x) * 0.015; // Slower dragon
                const my = (pRect.y - dragonRect.y) * 0.015;
                gameState.enemyDragon.moveBy(mx, my);

                if (checkCollision(pRect, dragonRect, 20)) {
                    if (gameState.carrying === 'sword') {
                        // Kill
                        gameState.dragonState = 'dead';
                        playSfx('kill');
                        updateWindowContent(gameState.enemyDragon, SPRITES.dead_dragon, '#ffeb3b');
                        document.getElementById('msg').innerText = "DRAGON SLAIN";
                    } else {
                        // Die
                        gameState.running = false;
                        document.getElementById('msg').innerText = "EATEN BY DRAGON";
                        document.body.style.backgroundColor = "#8b0000";
                    }
                }
            }
        }

        // Win
        if (gameState.carrying === 'chalice') {
            // Check bounds of main window
            if (pRect.x > window.screenX && 
                pRect.x < window.screenX + window.outerWidth &&
                pRect.y > window.screenY && 
                pRect.y < window.screenY + window.outerHeight) {
                
                if (!gameState.winFlash) {
                    gameState.winFlash = true;
                    playSfx('win');
                    document.getElementById('msg').innerText = "QUEST COMPLETE";
                    setInterval(() => {
                        let c = document.body.style.backgroundColor;
                        document.body.style.backgroundColor = (c === 'black') ? 'gold' : 'black';
                    }, 100);
                }
            }
        }
    }

    function closeAll() {
        if(gameState.playerWin) gameState.playerWin.close();
        if(gameState.itemChalice) gameState.itemChalice.close();
        if(gameState.itemSword) gameState.itemSword.close();
        if(gameState.enemyDragon) gameState.enemyDragon.close();
    }

    document.getElementById('btnStart').addEventListener('click', () => {
        closeAll();
        gameState.running = true;
        gameState.carrying = null;
        gameState.pickupTimer = 0;
        gameState.dragonState = 'alive';
        gameState.winFlash = false;
        document.getElementById('msg').innerText = "FIND THE CHALICE";

        const cx = MAX_W/2, cy = MAX_H/2;

        // Spawn
        gameState.playerWin = spawn("Player", cx, cy, null, "#ffeb3b"); // Yellow Player
        gameState.itemChalice = spawn("Chalice", MAX_W*0.8, MAX_H*0.8, SPRITES.chalice, "#ffeb3b"); // Yellow Chalice
        gameState.itemSword = spawn("Sword", MAX_W*0.2, MAX_H*0.8, SPRITES.sword, "#ffeb3b"); // Yellow Sword
        gameState.enemyDragon = spawn("Yorgle", MAX_W*0.8, MAX_H*0.2, SPRITES.dragon, "#32CD32"); // GREEN Dragon

        if(!gameState.playerWin) alert("Popups blocked! Please allow them.");
        
        window.focus();
        requestAnimationFrame(loop);
    });

    document.getElementById('btnClose').addEventListener('click', () => {
        closeAll();
        location.reload();
    });

    window.addEventListener('keydown', e => { if(e.code in KEYS) KEYS[e.code] = true; if(e.code==='Space') KEYS.Space=true; });
    window.addEventListener('keyup', e => { if(e.code in KEYS) KEYS[e.code] = false; if(e.code==='Space') KEYS.Space=false; });

    function loop() {
        gameLoop();
        requestAnimationFrame(loop);
    }

</script>
</body>
</html>